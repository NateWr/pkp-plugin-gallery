/*! pkp-plugin-gallery 2015-04-13 */
var pkppg=pkppg||{};pkppg.data=pkppg.data||pkppg_data,pkppg.cache=pkppg.cache||{},jQuery(document).ready(function(a){pkppg.form={init:function(){this.cache={},this.cache.body=pkppg.cache.body||a("body"),this.cache.releases=a(".pkp-releases-form"),this.cache.release_modal=a("#pkp-release-modal"),this.cache.release_fields=this.cache.release_modal.find(".pkp-release-fields"),this.cache.release_add=this.cache.releases.find(".pkp-release-form-buttons .add"),this.cache.release_save=this.cache.release_modal.find(".pkp-release-form-buttons .save"),this.cache.release_cancel=this.cache.release_modal.find(".pkp-release-form-buttons .cancel"),this.cache.release_status=this.cache.release_modal.find(".pkp-release-form-buttons .status"),this.current={},this.current.plugin=0,this.cache.release_add.click(this.showReleaseForm),this.cache.release_cancel.click(this.hideReleaseForm),this.cache.release_modal.click(function(b){a(b.target).is(pkppg.form.cache.release_modal)&&pkppg.form.hideReleaseForm()}),a(document).keyup(function(a){"27"==a.which&&pkppg.form.hideReleaseForm()}),this.cache.release_save.click(this.saveRelease),this.cache.releases.click(function(b){b.stopPropagation(),b.preventDefault();var c=a(b.target);c.hasClass("edit")?pkppg.form.loadRelease(c.parents(".release").data("id")):c.hasClass("delete")&&pkppg.form.deleteRelease(c.parents(".release").data("id"))})},showReleaseForm:function(b){var c;if("undefined"!=typeof b&&(b.stopPropagation(),b.preventDefault(),c=a(b.target).data("plugin")),pkppg.form.cache.body.addClass("pkppg-modal-is-visible"),pkppg.form.cache.release_modal.addClass("is-visible"),"undefined"!=typeof c&&(pkppg.form.current.plugin=c),"undefined"!=typeof pkppg.form.current.release){var d=pkppg.form.current.release,e=pkppg.form.cache.release_fields;e.find("#pkp-release-id").val(d.ID),e.find("#pkp-release-version").val(d.version),e.find("#pkp-release-date").val(d.release_date),e.find("#pkp-release-package").val(d["package"]),e.find("#pkp-release-description").val(d.description),e.find("#pkp-release-md5").val(d.md5),pkppg.form.current.plugin=d.plugin}},hideReleaseForm:function(a){"undefined"!=typeof a&&(a.stopPropagation(),a.preventDefault()),pkppg.form.cache.release_cancel.attr("disabled")||(pkppg.form.cache.body.removeClass("pkppg-modal-is-visible"),pkppg.form.cache.release_modal.removeClass("is-visible"),pkppg.form.cache.release_fields.find("input, textarea").val(""),delete pkppg.form.current.release,pkppg.form.current.plugin=0)},loadRelease:function(b){var c={};c.action="pkppg-get-release",c.nonce=pkppg.data.nonce,c.release=b;var d=a.param(c);a.get(pkppg.data.ajaxurl,d).done(function(a){console.log(a),a.success&&(pkppg.form.current.release=a.data.release,pkppg.form.showReleaseForm())})},deleteRelease:function(a){console.log("deleteRelease:"+a)},saveRelease:function(b){if("undefined"!=typeof b&&(b.stopPropagation(),b.preventDefault()),!pkppg.form.cache.release_save.attr("disabled")){pkppg.form.setStatus("working");var c={};c.action="pkppg-insert-release",c.nonce=pkppg.data.nonce,c.release=pkppg.form.objectFromForm();var d=a.param(c);a.post(pkppg.data.ajaxurl,d,function(a){a.success?(pkppg.form.setStatus("success"),pkppg.form.updateReleaseList(a.data.release.ID,a.data.overview),setTimeout(pkppg.form.hideReleaseForm,1e3)):pkppg.form.setStatus("error"),setTimeout(pkppg.form.resetStatus,4e3)})}},objectFromForm:function(){for(var a={},b=pkppg.form.cache.release_modal.find("form").serializeArray(),c=0;c<b.length;c++)a[b[c].name]=b[c].value;return this.current.plugin&&(a.plugin=this.current.plugin),a},setStatus:function(a){pkppg.form.cache.release_status.removeClass("working success error").addClass(a);var b="working"===a?!0:!1;pkppg.form.cache.release_save.attr("disabled",b),pkppg.form.cache.release_cancel.attr("disabled",b)},resetStatus:function(){pkppg.form.cache.release_status.removeClass("working success error"),pkppg.form.cache.release_save.attr("disabled",!1),pkppg.form.cache.release_cancel.attr("disabled",!1)},updateReleaseList:function(b,c){var d=!1;pkppg.form.cache.releases.find(".release").each(function(){return a(this).data("id")==b?(a(this).parent().html(c),void(d=!0)):void 0}),d||pkppg.form.cache.releases.find(".releases").append("<li>"+c+"</li>")}},pkppg.form.init()});