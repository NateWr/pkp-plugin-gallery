/*! pkp-plugin-gallery 2015-04-30 */
var pkppg=pkppg||{};jQuery(document).ready(function(a){pkppg.data=pkppg.data||pkppg_data,pkppg.cache=pkppg.cache||{},pkppg.cache.body=pkppg.cache.body||a("body")});var pkppg=pkppg||{};jQuery(document).ready(function(a){pkppg.form={init:function(){this.cache={},this.cache.body=pkppg.cache.body||a("body"),this.cache.releases=a(".pkp-releases-form"),this.cache.release_modal=a("#pkp-release-modal"),this.cache.release_fields=this.cache.release_modal.find(".pkp-release-fields"),this.cache.release_add=this.cache.releases.find(".pkp-release-form-buttons .add"),this.cache.release_save=this.cache.release_modal.find(".pkp-release-form-buttons .save"),this.cache.release_cancel=this.cache.release_modal.find(".pkp-release-form-buttons .cancel"),this.cache.release_status=this.cache.release_modal.find(".pkp-release-form-buttons .status"),this.current={},this.current.plugin=0,this.cache.release_add.click(this.showReleaseForm),this.cache.release_cancel.click(this.hideReleaseForm),this.cache.release_modal.click(function(b){a(b.target).is(pkppg.form.cache.release_modal)&&pkppg.form.hideReleaseForm()}),a(document).keyup(function(a){"27"==a.which&&pkppg.form.hideReleaseForm()}),this.cache.release_save.click(this.saveRelease),this.cache.releases.click(function(b){b.stopPropagation(),b.preventDefault();var c=a(b.target);if(!c.attr("disabled")){var d=c.parents(".release");d&&c.hasClass("edit")?pkppg.form.loadRelease(d.data("id")):d&&c.hasClass("delete")?pkppg.form.deleteRelease(d.data("id")):d&&c.hasClass("publish")&&pkppg.form.publishRelease(d.data("id"))}})},showReleaseForm:function(b){var c;if("undefined"!=typeof b&&(b.stopPropagation(),b.preventDefault(),c=a(b.target).data("plugin")),pkppg.form.cache.body.addClass("pkppg-modal-is-visible"),pkppg.form.cache.release_modal.addClass("is-visible"),"undefined"!=typeof c&&(pkppg.form.current.plugin=c),"undefined"!=typeof pkppg.form.current.release){var d=pkppg.form.current.release,e=pkppg.form.cache.release_fields;e.find("#pkp-release-id").val(d.ID),e.find("#pkp-release-version").val(d.version),e.find("#pkp-release-date").val(d.release_date),e.find("#pkp-release-package").val(d["package"]),e.find("#pkp-release-description").val(d.description),e.find("#pkp-release-md5").val(d.md5),d.certification&&e.find('.certification option[value="'+d.certification+'"]').attr("selected","selected"),d.applications.length&&e.find(".applications input").each(function(){-1!==a.inArray(a(this).val(),d.applications)&&a(this).attr("checked","checked")}),pkppg.form.current.plugin=d.plugin}},hideReleaseForm:function(a){"undefined"!=typeof a&&(a.stopPropagation(),a.preventDefault()),pkppg.form.cache.release_cancel.attr("disabled")||(pkppg.form.cache.body.removeClass("pkppg-modal-is-visible"),pkppg.form.cache.release_modal.removeClass("is-visible"),pkppg.form.cache.release_fields.find('input[type="hidden"], input[type="text"], input[type="url"], textarea').val(""),pkppg.form.cache.release_fields.find("option:selected").removeAttr("selected"),pkppg.form.cache.release_fields.find('input[type="checkbox"]').removeAttr("checked"),delete pkppg.form.current.release,pkppg.form.current.plugin=0)},loadRelease:function(b){pkppg.form.setReleaseStatus(b,"loading");var c={};c.action="pkppg-get-release",c.nonce=pkppg.data.nonce,c.release=b;var d=a.param(c);a.get(pkppg.data.ajaxurl,d).done(function(a){pkppg.form.resetReleaseStatus(b),a.success&&(pkppg.form.current.release=a.data.release,pkppg.form.showReleaseForm())})},deleteRelease:function(b){pkppg.form.setReleaseStatus(b,"deleting");var c={};c.action="pkppg-delete-release",c.nonce=pkppg.data.nonce,c.release=b;var d=a.param(c);a.post(pkppg.data.ajaxurl,d).done(function(a){pkppg.form.resetReleaseStatus(b),a.success&&pkppg.form.removeReleaseFromList(b)})},saveRelease:function(b){if("undefined"!=typeof b&&(b.stopPropagation(),b.preventDefault()),!pkppg.form.cache.release_save.attr("disabled")){pkppg.form.setModalStatus("working");var c={};c.action="pkppg-insert-release",c.nonce=pkppg.data.nonce,c.release=pkppg.form.objectFromForm();var d=a.param(c);a.post(pkppg.data.ajaxurl,d,function(a){a.success?(pkppg.form.setModalStatus("success"),pkppg.form.updateReleaseInList(a.data.release.ID,a.data.overview),setTimeout(pkppg.form.hideReleaseForm,1e3)):pkppg.form.setModalStatus("error"),setTimeout(pkppg.form.resetModalStatus,4e3)})}},publishRelease:function(b){pkppg.form.setReleaseStatus(b,"publishing");var c={};c.action="pkppg-publish-release",c.nonce=pkppg.data.nonce,c.release=b;var d=a.param(c);a.post(pkppg.data.ajaxurl,d).done(function(a){pkppg.form.resetReleaseStatus(b),a.success&&pkppg.form.updateReleaseInList(a.data.release.ID,a.data.overview)})},objectFromForm:function(){for(var a={},b=pkppg.form.cache.release_modal.find("form").serializeArray(),c=0;c<b.length;c++)"tax_input[pkp_certification]"==b[c].name?a.certification=b[c].value:"tax_input[pkp_application][]"==b[c].name?("undefined"==typeof a.applications&&(a.applications=[]),a.applications.push(b[c].value)):a[b[c].name]=b[c].value;return this.current.plugin&&(a.plugin=this.current.plugin),a},setReleaseStatus:function(a,b){var c=pkppg.form.getReleaseEl(a);c&&(c.find(".actions").addClass(b).find("a").attr("disabled",!0),"loading"==b&&pkppg.form.cache.releases.find(".release .edit").attr("disabled",!0))},resetReleaseStatus:function(a){pkppg.form.cache.releases.find(".release .actions a").attr("disabled",!1);var b=pkppg.form.getReleaseEl(a);b&&b.find(".actions").removeClass("loading deleting publishing").find("a").attr("disabled",!1)},setModalStatus:function(a){pkppg.form.cache.release_status.removeClass("working success error").addClass(a);var b="working"===a?!0:!1;pkppg.form.cache.release_save.attr("disabled",b),pkppg.form.cache.release_cancel.attr("disabled",b)},resetModalStatus:function(){pkppg.form.cache.release_status.removeClass("working success error"),pkppg.form.cache.release_save.attr("disabled",!1),pkppg.form.cache.release_cancel.attr("disabled",!1)},updateReleaseInList:function(a,b){var c=!1,d=pkppg.form.getReleaseEl(a);return d?(d.parent().html(b),void(c=!0)):void(c||pkppg.form.cache.releases.find(".releases").append("<li>"+b+"</li>"))},removeReleaseFromList:function(b){var c=pkppg.form.getReleaseEl(b);c&&c.parent().fadeOut(500,function(){a(this).remove()})},getReleaseEl:function(b){var c;return pkppg.form.cache.releases.find(".release").each(function(){a(this).data("id")==b&&(c=a(this))}),c}},pkppg.form.init()});